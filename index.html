<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COLDEX Sample Finder</title>
  <style>
    :root { --gap: 10px; --pad: 12px; --radius: 12px; }
    body { font: 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0b1020; color:#eef2ff;}
    .wrap { max-width: 1150px; margin: 0 auto; padding: 28px; }
    h1 { font-size: 22px; margin: 0 0 18px; }
    .card { background:#121936; border:1px solid #1e2752; border-radius: var(--radius); padding: var(--pad); box-shadow: 0 6px 20px rgba(0,0,0,.25); }
    .grid { display: grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap: var(--gap); }
    .grid > div { display:flex; flex-direction:column; }
    label { font-size: 12px; color:#aab4ff; margin-bottom:6px; letter-spacing:.2px;}
    input, select, button { border-radius: 10px; border:1px solid #2b356e; background:#0f1530; color:#eef2ff; padding: 10px 12px; }
    input::placeholder { color:#7f89c9; }
    .actions { display:flex; gap: var(--gap); align-items:center; }
    .btn { cursor:pointer; font-weight:600; }
    .btn-primary { background:#335bff; border-color:#335bff; }
    .btn-ghost { background:transparent; }
    .muted { color:#aab4ff; font-size: 13px; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 10px 12px; border-bottom:1px solid #1d254e; vertical-align: top; }
    th { position: sticky; top: 0; background:#121936; z-index: 1; }
    .table-wrap { overflow:auto; max-height: 70vh; border-radius: 10px; border:1px solid #1e2752; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2b356e; font-size:12px; color:#cbd3ff; background:#0f1530; }
    .foot { display:flex; justify-content: space-between; align-items:center; margin-top: var(--gap); }
    .error { background:#2c1220; border:1px solid #a13357; color:#ffd4df; padding:10px 12px; border-radius:10px; margin-top:10px; display:none;}
    .ok { display:none; }
    .sr { position:absolute; left:-9999px; }
  
#coreRefreshBtn {
  background: transparent;
  border: 1px solid #2b356e;
  border-radius: 6px;
  cursor: pointer;
  color: #aab4ff;
  font-weight: 600;
  padding: 2px 8px;
  margin-left: 6px;
}
#coreRefreshBtn:hover {
  background: #1e2752;
}
label[for="coreId"] {
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

</style>
</head>
<body>
  <div class="wrap">
    <h1>COLDEX Sample Finder</h1>

    <div class="card" style="margin-bottom:16px;">
      <form id="searchForm">
        <div class="grid">
          <div>
            <label for="coreId">Core ID</label>
            <select id="coreId" name="coreId">
              <option value="">(All cores)</option>
            </select>
          </div>
          <div>
            <label for="minDepth">Min depth (m)</label>
            <input id="minDepth" name="minDepth" type="number" step="0.01" placeholder="e.g., 60" />
          </div>
          <div>
            <label for="maxDepth">Max depth (m)</label>
            <input id="maxDepth" name="maxDepth" type="number" step="0.01" placeholder="e.g., 90" />
          </div>
          <div>
            <label for="status">Status</label>
            <select id="status" name="status">
              <option value="available" selected>available</option>
              <option value="">(ignore)</option>
              <option value="consumed">consumed</option>
            </select>
          </div>
          <div class="actions" style="align-self:end;">
            <button id="runBtn" class="btn btn-primary" type="submit">Search</button>
            <button id="resetBtn" class="btn btn-ghost" type="button">Reset</button>
          </div>
          <div class="actions" style="align-self:end; justify-content:flex-end;">
            <button id="csvBtn" class="btn btn-ghost" type="button" title="Download CSV">Download CSV</button>
          </div>
        </div>
        <div id="err" class="error"></div>
      </form>
      <div class="foot">
        <div id="count" class="muted">0 results</div>
        <div class="muted">Depth filters include any sample overlapping the window. Please contact the data manager if you see any errors.</div>
      </div>
    </div>

    <div class="table-wrap card">
      <table id="tbl">
        <thead>
          <tr>
            <th>Record ID</th>
            <th>Core ID</th>
            <th>Section #</th>
            <th>Top (m)</th>
            <th>Bottom (m)</th>
            <th>Length (m)</th>
            <th>Remaining (m)</th>
            <th>Subsampled?</th>
            <th>Status</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="10" class="muted">Run a search…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Supabase JS (UMD build) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
  // === 1) CONFIG ===========================================================
  const SUPABASE_URL = 'https://qkmxlmpotcsfxroxbnir.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrbXhsbXBvdGNzZnhyb3hibmlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NjUwMjUsImV4cCI6MjA3NDI0MTAyNX0.v3_MMFUjsGZUd5qgUX0k31xCz0Syi9syEnY_C-QZouU';
  const RPC_FUNCTION = 'search_samples';
  // ========================================================================

  const client   = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // Expose for console debugging
  window.client = client;
const form     = document.getElementById('searchForm');
  const runBtn   = document.getElementById('runBtn');
  const resetBtn = document.getElementById('resetBtn');
  const csvBtn   = document.getElementById('csvBtn');
  const tbody    = document.getElementById('tbody');
  const countEl  = document.getElementById('count');
  const errEl    = document.getElementById('err');

  let lastResults = [];

  function showError(msg) {
    errEl.textContent = msg;
    errEl.style.display = 'block';
  }
  function clearError() {
    errEl.textContent = '';
    errEl.style.display = 'none';
  }
  function numberOrNull(v) {
    if (v === '' || v === null || v === undefined) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function renderRows(rows) {
    tbody.innerHTML = '';
    if (!rows || rows.length === 0) {
      tbody.innerHTML = '<tr><td class="muted" colspan="10">No results.</td></tr>';
      return;
    }
    const esc = (s) => (s ?? '').toString()
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <button class="pill" data-record-id="${esc(r.record_id)}"
                  style="cursor:pointer; background:none; border:1px solid #2b356e;">
            ${esc(r.record_id)}
          </button>
        </td>
        <td>${esc(r.core_id)}</td>
        <td>${esc(r.section_number)}</td>
        <td>${r.top_depth_m ?? ''}</td>
        <td>${r.bottom_depth_m ?? ''}</td>
        <td>${r.length_m ?? ''}</td>
        <td>${r.remaining_m ?? ''}</td>
        <td>${r.has_subsamples ? 'Yes' : 'No'}</td>
        <td>${esc(r.status ?? '')}</td>
        <td>${esc(r.notes ?? '')}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function toCSV(rows) {
    const cols = [
      'record_id','core_id','section_number','top_depth_m','bottom_depth_m',
      'length_m','remaining_m','has_subsamples','subsample_count','status','notes'
    ];
    const header = cols.join(',');
    const lines = rows.map(r =>
      cols.map(c => {
        let v = r[c];
        if (v === null || v === undefined) v = '';
        v = String(v);
        return /[",\n]/.test(v) ? `"${v.replaceAll('"','""')}"` : v;
      }).join(',')
    );
    return [header, ...lines].join('\n');
  }

  function downloadCSV(rows) {
    if (!rows || rows.length === 0) return;
    const blob = new Blob([toCSV(rows)], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'coldex_available_samples.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Depth overlap helper (client-side)
  function overlaps(row, min, max) {
    if (min == null && max == null) return true;
    const top = Number(row.top_depth_m);
    const bot = Number(row.bottom_depth_m);
    if (!Number.isFinite(top) || !Number.isFinite(bot)) return false;
    if (min != null && bot < min) return false;
    if (max != null && top > max) return false;
    return true;
  }

  async function runSearch(ev) {
    ev?.preventDefault();
    clearError();
    runBtn.disabled = true;
    runBtn.textContent = 'Searching…';

    function toNullOrText(v) {
      const x = (v ?? '').trim();
      return x === '' ? null : x;
    }
    function toNullOrNumber(v) {
      const x = (v ?? '').trim();
      if (x === '') return null;
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    const coreId   = toNullOrText(document.getElementById('coreId').value);
    const minDepth = toNullOrNumber(document.getElementById('minDepth').value);
    const maxDepth = toNullOrNumber(document.getElementById('maxDepth').value);

    // IMPORTANT: default Status select is "available".
    // If you want "ignore" by default, change the HTML default or force-null here.
    const rawStatus = document.getElementById('status').value.trim();
    const status    = rawStatus === '' ? null : rawStatus;

    console.log({ coreId, minDepth, maxDepth, status });

    const { data, error } = await client.rpc(RPC_FUNCTION, {
      p_core_id:   coreId,
      p_min_depth: minDepth,
      p_max_depth: maxDepth,
      p_status:    status
    });

    runBtn.disabled = false;
    runBtn.textContent = 'Search';

    if (error) {
      showError(error.message || 'Unknown error');
      console.error(error);
      return;
    }

    const filtered = Array.isArray(data)
      ? data.filter(r => overlaps(r, minDepth, maxDepth))
      : [];

    lastResults = filtered;
    countEl.textContent = `${filtered.length} result${filtered.length === 1 ? '' : 's'}`;
    renderRows(filtered);
  }

// === Core codes cache + loader =============================================
const CORE_CACHE_KEY = 'coreCodes:v2';           // bump version to invalidate old cache
const CORE_CACHE_TTL_MS = 12 * 60 * 60 * 1000;   // 12 hours

function readCoreCache() {
  try {
    const raw = localStorage.getItem(CORE_CACHE_KEY);
    if (!raw) return null;
    const { codes, ts } = JSON.parse(raw);
    if (!Array.isArray(codes) || typeof ts !== 'number') return null;
    const fresh = (Date.now() - ts) < CORE_CACHE_TTL_MS;
    return { codes, fresh };
  } catch { return null; }
}

function writeCoreCache(codes) {
  try {
    localStorage.setItem(CORE_CACHE_KEY, JSON.stringify({ codes, ts: Date.now() }));
  } catch {}
}

function fillCoreSelect(codes) {
  const select = document.getElementById('coreId');
  const label = document.querySelector('label[for="coreId"]');
  if (!select) return;
  select.innerHTML = '<option value="">(All cores)</option>';
  for (const code of codes) {
    const opt = document.createElement('option');
    opt.value = code;
    opt.textContent = code;
    select.appendChild(opt);
  }
  select.disabled = false;
  if (label) {
    let badge = document.getElementById('coreCountBadge');
    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'coreCountBadge';
      badge.className = 'pill';
      badge.style.marginLeft = '6px';
      label.appendChild(badge);
    }
    badge.textContent = codes.length;
  }
}

async function fetchCoreCodesNetwork() {
  // Strategy 1: public view
  try {
    const { data, error } = await client.from('core_codes').select('core_code').order('core_code', { ascending: true });
    if (error) throw error;
    const codes = (data ?? []).map(r => (r.core_code || '').trim()).filter(Boolean);
    if (codes.length) return codes;
  } catch (e) { console.warn('View core_codes failed:', e.message || e); }

  // Strategy 2: RPC
  try {
    const { data, error } = await client.rpc('coldex_get_core_ids');
    if (error) throw error;
    const codes = (data ?? []).map(r => (r.core_id || '').trim()).filter(Boolean);
    if (codes.length) return codes;
  } catch (e) { console.warn('RPC coldex_get_core_ids failed:', e.message || e); }

  // Strategy 3: direct schema read
  try {
    const { data, error } = await client.schema('coldex').from('cores').select('core_code').order('core_code', { ascending: true });
    if (error) throw error;
    const codes = (data ?? []).map(r => (r.core_code || '').trim()).filter(Boolean);
    if (codes.length) return codes;
  } catch (e) { console.warn('Direct coldex.cores read failed:', e.message || e); }

  return [];
}

// Populate with cache (if fresh) and then revalidate in background.
async function populateCoreDropdown() {
  const select = document.getElementById('coreId');
  if (!select) return;
  select.disabled = true;
  select.innerHTML = '<option value="">Loading…</option>';

  // 1) Try cache
  const cached = readCoreCache();
  if (cached?.codes?.length) {
    fillCoreSelect(cached.codes);
  }

  // 2) Network fetch (always) and update if different
  const liveCodes = await fetchCoreCodesNetwork();
  if (liveCodes.length) {
    const cachedStr = JSON.stringify((cached?.codes) || []);
    const liveStr   = JSON.stringify(liveCodes);
    if (cachedStr !== liveStr) {
      fillCoreSelect(liveCodes);
      writeCoreCache(liveCodes);
    } else if (!cached?.fresh) {
      // Cache exists but stale; refresh timestamp
      writeCoreCache(liveCodes);
    }
  } else if (!cached?.codes?.length) {
    // Nothing to show
    select.innerHTML = '<option value="">(No cores found)</option>';
    select.disabled = false;
  }
}

// Ensure the select exists
function ensureCoreSelect() {
  let select = document.getElementById('coreId');
  const container = document.querySelector('label[for="coreId"]')?.parentElement;
  if (!select && container) {
    select = document.createElement('select');
    select.id = 'coreId';
    select.name = 'coreId';
    select.innerHTML = '<option value="">(All cores)</option>';
    container.appendChild(select);
  }
}

// --- Final guaranteed refresh button attachment ----------------------------
function attachCoreRefreshButton() {
  const tryAttach = () => {
    const coreContainer = document.querySelector('#coreId')?.parentElement;
    if (coreContainer && !document.getElementById('coreRefreshBtn')) {
      const btn = document.createElement('button');
      btn.id = 'coreRefreshBtn';
      btn.textContent = '↻';
      btn.title = 'Refresh core list';
      btn.style.padding = '2px 8px';
      btn.style.marginTop = 'auto';
      btn.style.marginLeft = '4px';
      btn.style.height = '36px';
      btn.style.borderRadius = '6px';
      btn.style.border = '1px solid #2b356e';
      btn.style.background = 'transparent';
      btn.style.color = '#aab4ff';
      btn.style.cursor = 'pointer';
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        btn.textContent = '…';
        btn.disabled = true;
        localStorage.removeItem(CORE_CACHE_KEY);
        await populateCoreDropdown();
        btn.textContent = '↻';
        btn.disabled = false;
      });
      coreContainer.style.display = 'flex';
      coreContainer.style.alignItems = 'center';
      coreContainer.appendChild(btn);
      console.log('Core refresh button attached.');
    } else if (!document.getElementById('coreRefreshBtn')) {
      setTimeout(tryAttach, 300);
    }
  };
  tryAttach();
}

document.addEventListener('DOMContentLoaded', attachCoreRefreshButton);

// Always ensure button exists after dropdown loads
document.addEventListener('DOMContentLoaded', attachCoreRefreshButton);

form.addEventListener('submit', runSearch);
  resetBtn.addEventListener('click', () => {
    form.reset(); clearError();
    lastResults = []; renderRows([]); countEl.textContent = '0 results';
  });
  csvBtn.addEventListener('click', () => downloadCSV(lastResults));

  // ---------- Order-proof modal wiring ----------
  function $id(id){ return document.getElementById(id); }
  function openDetail(){ const m=$id('detailModal'); if (m) m.style.display='flex'; }
  function closeDetail(){ const m=$id('detailModal'); if (m) m.style.display='none'; }

  document.addEventListener('DOMContentLoaded', () => {
    const modal   = $id('detailModal');
    const closeBn = $id('detailClose');
    if (modal)   modal.addEventListener('click', (e) => { if (e.target === modal) closeDetail(); });
    if (closeBn) closeBn.addEventListener('click', closeDetail);
  });

  // Delegate Record-ID clicks from the results table
  tbody.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-record-id]');
    if (!btn) return;
    const recordId = btn.getAttribute('data-record-id');
    await showSampleDetail(recordId);
  });

  // global esc helper for modal rendering
  function esc(s) {
    return (s ?? '').toString()
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  async function showSampleDetail(recordId) {
  const title = $id('detailTitle');
  const body  = $id('detailBody');
  if (title) title.textContent = `Sample ${recordId}`;
  if (body)  body.innerHTML = 'Loading…';
  openDetail();

  const { data, error } = await client.rpc('get_sample_detail', { p_record_id: recordId });
  if (error) {
    console.error(error);
    if (body) body.innerHTML = `<div class="error" style="display:block">Error: ${esc(error.message)}</div>`;
    return;
  }
  if (!data || data.length === 0) {
    if (body) body.innerHTML = `<div class="muted">No detail found.</div>`;
    return;
  }

  const row  = data[0];
  const subs = Array.isArray(row.subsamples) ? row.subsamples : [];

  // Build subsample rows first (no nested template literals later)
  const subsRows = subs.map(s => `
    <tr>
      <td>${esc(s.subsample_id)}</td>
      <td>${s.top_depth_m ?? ''}</td>
      <td>${s.bottom_depth_m ?? ''}</td>
      <td>${s.length_m ?? ''}</td>
      <td>${esc(s.status ?? '')}</td>
      <td>${esc(s.destination ?? '')}</td>
      <td>${esc(s.date_sent ?? '')}</td>
      <td>${esc(s.purpose_notes ?? '')}</td>
      <td>${esc(s.cut_shape ?? '')}</td>
      <td>${esc(s.linked_shipment ?? '')}</td>
      <td>${esc(s.request_id ?? '')}</td>
    </tr>
  `).join('');

  const subsTable = subs.length === 0
    ? '<div class="muted">None</div>'
    : (
      '<div class="table-wrap" style="max-height:50vh;">' +
        '<table>' +
          '<thead>' +
            '<tr>' +
              '<th>Subsample ID</th>' +
              '<th>Top (m)</th>' +
              '<th>Bottom (m)</th>' +
              '<th>Length (m)</th>' +
              '<th>Status</th>' +
              '<th>Destination</th>' +
              '<th>Date sent</th>' +
              '<th>Purpose</th>' +
              '<th>Cut shape</th>' +
              '<th>Shipment</th>' +
              '<th>Request ID</th>' +
            '</tr>' +
          '</thead>' +
          '<tbody>' + subsRows + '</tbody>' +
        '</table>' +
      '</div>'
    );

  const sampleTable = `
    <div style="display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:12px;">
      <div class="card">
        <h3 style="margin-top:0;">Sample</h3>
        <table>
          <tr><th style="width:160px;">Record ID</th><td><code class="pill">${esc(recordId)}</code></td></tr>
          <tr><th>Core ID</th><td>${esc(row.core_id)}</td></tr>
          <tr><th>Section #</th><td>${esc(row.section_number)}</td></tr>
          <tr><th>Top (m)</th><td>${row.top_depth_m ?? ''}</td></tr>
          <tr><th>Bottom (m)</th><td>${row.bottom_depth_m ?? ''}</td></tr>
          <tr><th>Length (m)</th><td>${row.length_m ?? ''}</td></tr>
          <tr><th>Remaining (m)</th><td>${row.remaining_m ?? ''}</td></tr>
          <tr><th>Status</th><td>${esc(row.status ?? '')}</td></tr>
          <tr><th>Notes</th><td>${esc(row.notes ?? '')}</td></tr>
        </table>
      </div>
      <div class="card">
        <h3 style="margin-top:0;">Subsamples <span class="pill">${row.subsample_count ?? 0}</span></h3>
        ${subsTable}
      </div>
    </div>
  `;

  if (body) body.innerHTML = sampleTable;
}

</script>

  <div id="detailModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50;">
  <div id="detailCard" class="card" style="max-width:800px; width:95%; max-height:85vh; overflow:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px;">
      <h2 id="detailTitle" style="margin:0; font-size:18px;">Sample Detail</h2>
      <button id="detailClose" class="btn btn-ghost" type="button">Close</button>
    </div>
    <div id="detailBody" class="muted">Loading…</div>
  </div>
</div>

</body>
</html>
